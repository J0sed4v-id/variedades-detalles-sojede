{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras - Sojede</title>
    <link rel="stylesheet" type="text/css" href="{% static 'compras.css' %}">

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <!-- ===== HEADER ===== -->
    <header class="header-sojede">
        <div class="header-left">
            <img src="{% static 'images/logo.jpg' %}" alt="Logo Sojede" class="logo-img">
            <nav class="nav-sojede">
                <a href="{% url 'dashboard' %}">Inicio</a>
                <a href="{% url 'productos' %}" class="{% if request.resolver_match.url_name == 'productos' %}active{% endif %}">Productos</a>
                <a href="{% url 'inventario' %}" class="{% if request.resolver_match.url_name == 'inventario' %}active{% endif %}">Inventario</a>
                <a href="{% url 'compras' %}" class="{% if request.resolver_match.url_name == 'compras' %}active{% endif %}">Compras</a>
            </nav>
        </div>
        <a href="{% url 'cerrar_sesion' %}" class="btn-logout-sojede">Cerrar sesi√≥n</a>
    </header>

    <!-- ===== CONTENIDO PRINCIPAL ===== -->
    <main class="main-sojede">
        <section class="compras-container">

            <!-- ===== FORMULARIO DE A√ëADIR COMPRA ===== -->
            <h2>‚ûï A√±adir compra</h2>
            <form method="post" action="{% url 'compras' %}" class="form-compras">
                {% csrf_token %}

                <div class="form-row">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" name="fecha_compra" required>

                    <label for="producto">Producto:</label>
                    <select id="producto" name="producto_id" required></select>

                    <label for="total">Total:</label>
                    <input type="number" id="total" name="total" min="0" step="0.01" placeholder="0.00" required>
                </div>

                <div class="form-row">
                    <label for="cantidad">Cantidad:</label>
                    <input type="number" id="cantidad" name="cantidad" min="1" step="1" value="1" required>

                    <label for="categoria">Categor√≠a:</label>
                    <select id="categoria" name="categoria" required>
                        <option value="">Seleccione</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria }}">{{ categoria }}</option>
                        {% endfor %}
                    </select>

                    <button type="submit" class="btn-guardar">üíæ Guardar Compra</button>
                </div>
            </form>

            <hr>

            <!-- ===== BUSCADOR ===== -->
            <div class="buscador-compras">
                <input type="text" id="buscar-fecha" placeholder="üîç Buscar compras por fecha...">
            </div>

            <!-- ===== TABLA DE COMPRAS ===== -->
            <table class="tabla-compras">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Producto</th>
                        <th>Categor√≠a</th>
                        <th>Cantidad</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if compras %}
                        {% for compra in compras %}
                            <tr>
                                <td>{{ compra.fecha_compra|date:"d/m/Y" }}</td>
                                <td>{{ compra.producto.nombre }}</td>
                                <td>{{ compra.producto.categoria }}</td>
                                <td>{{ compra.cantidad }}</td>
                                <td>${{ compra.total|floatformat:2 }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" style="text-align:center;">No hay compras registradas.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>

            <a href="{% url 'dashboard' %}" class="boton-volver">‚Üê Volver al Dashboard</a>
        </section>
    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="footer-sojede">
        <p>¬© 2025 Variedades y Detalles Sojede ‚Äî Todos los derechos reservados</p>
        <p>soporte.sojede@gmail.com</p>
    </footer>

    <!-- ===== SCRIPTS ===== -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      $(document).ready(function() {
        // Inicializar Select2 en campo producto
        $('#producto').select2({
          placeholder: "Buscar producto...",
          allowClear: true,
          ajax: {
            url: "{% url 'buscar_productos' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
              return { q: params.term };
            },
            processResults: function (data) {
              return { results: data.results };
            },
            cache: true
          },
          minimumInputLength: 1,
          width: '200px'
        });

        // Buscador por fecha (filtro r√°pido en tabla)
        $('#buscar-fecha').on('keyup', function() {
          var valor = $(this).val().toLowerCase();
          $('.tabla-compras tbody tr').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(valor) > -1)
          });
        });
      });
    </script>
</body>
</html>
